---
title: "presimulate.observed.mort.draws_LASTING_cluster_documentation"
author: "Fred Cudhea"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Documentation for R script: presimulate.observed.mort.draws_cluster.r, which creates simulation draws for morality/incidence counts of the subgroups of interest based on estimates for mean and corresponding standard errors. I call it "pre"-simulate because I'm creating the draws before doing the simulating of PIFs. It's useful to create these sims at the beginning (as opposed to redoing them when we calculate PIFs for each outcome) so we can use a consistent set of sims for all health outcomes.   

First, read in input file with CMD/Cancer incidence/death data, and do change some some processing (change some variable names and subset to variables on interest). Note that, if you decide to change the strata names or end up adding/subtracing strata, you'll have to make corresponding changes to the code (specfically, where you define vars.to.keep).
```{r read_in,eval=FALSE, echo=TRUE}
##pre-simulate mort/incidence draws

#library(Kmisc)

#setwd("C:\\Users\\jliu28\\Box Sync\\Juju and Fred\\Fangfang's cancer burden PAF")
#setwd("/Users/fcudhe01/Box Sync/Juju and Fred/Fangfang's cancer burden PAF")
#setwd(file_location)
#setwd("Inputs")
#setwd("C:\\Users\\fcudhe01\\Box Sync\\new life\\Cancer-CRA-organized\\inputs")


#raw.file.name<-paste("All_Sites_Incidence_", incidence.version.date, ".csv", sep="")
#raw.file<-read.csv(raw.file.name)

#file_location = paste("C:\\Users\\", Sys.info()[7], "\\Box\\lasting_aim_3\\model development\\data_new\\in\\TEMP", sep="")
#setwd(file_location)
#raw.file.name<-"in/TEMP/cancer_incidence_10.3.22_TEMP.csv"
#raw.file.name<-"in/TEMP/CVD_cancer_merged_1.23.23_TEMP.csv"
#raw.file.name<-"CRA_inputs/CVD_cancer_merged_2.28.23_TEMP.csv"
#raw.file.name<-"CVD_cancer_merged_2.28.23_TEMP.csv"
raw.file.name<-paste("cvd_cancer_merged_", version.date, "_FINAL.csv", sep="")


raw.file<-read.csv(raw.file.name, fileEncoding = 'UTF-8-BOM')

# remove BMImed and SBPmed for now
index <- grep(pattern="_medBMI|_medSBP", x=raw.file$diseases)
raw.file <- raw.file[-index,]

# raw.file$Sex[raw.file$Sex=="  Female"]<-"Female"
# raw.file$Sex[raw.file$Sex=="  Male"]<-"Male"
raw.file$Sex<-factor(raw.file$Sex)

# dont' need this
# raw.file$se<-raw.file$crude_se*raw.file$population/100000

# set se to crude_se
raw.file$se <- raw.file$crude_se

# raw.file$disease<-""
# 
# raw.file$disease[as.character(raw.file$CancerSite)=="Esophagus"]<-"EC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Lung and Bronchus"]<-"LC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Lung"]<-"LC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Colon and Rectum"]<-"CC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Breast"]<-"BC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Female Breast"]<-"BC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Gallbladder"]<-"GC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Stomach"]<-"SC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Pancreas"]<-"PC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Kidney and Renal Pelvis"]<-"KC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Liver and Intrahepatic Bile Duct"]<-"LVC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Thyroid"]<-"TC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Ovary"]<-"OC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Corpus Uteri"]<-"UC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Esophagus: Adenomas and adenocarcinomas"]<-"ECA"
# raw.file$disease[as.character(raw.file$CancerSite)=="Esophageal Adenocarcinoma"]<-"ECA"
# raw.file$disease[as.character(raw.file$CancerSite)=="Esophagus: Squamous cell neoplasm"]<-"ECSCN"
# raw.file$disease[as.character(raw.file$CancerSite)=="Stomach: Cardia, NOS"]<-"SCC" 
# raw.file$disease[as.character(raw.file$CancerSite)=="Stomach Cardia"]<-"SCC" 
# raw.file$disease[as.character(raw.file$CancerSite)=="Stomach: Non Cardia, NOS"]<-"SCNC" 
# raw.file$disease[as.character(raw.file$CancerSite)=="Stomach Non-Cardia"]<-"SCNC" 
# raw.file$disease[as.character(raw.file$CancerSite)=="Stomach Non-cardia"]<-"SCNC" 
# raw.file$disease[as.character(raw.file$CancerSite)=="Myeloma: Multiple myeloma/plasma-cell leuk"]<-"MMC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Myeloma: Multiple myeloma/plasma-c"]<-"MMC"
# raw.file$disease[as.character(raw.file$CancerSite)=="Multiple Myeloma"]<-"MMC" 
# raw.file$disease[as.character(raw.file$CancerSite)=="meningiomas: meningiomas"]<-"MC" 
# raw.file$disease[as.character(raw.file$CancerSite)=="Oral Cavity and Pharynx"]<-"MPLC" 
# raw.file$disease[as.character(raw.file$CancerSite)=="Larynx"]<-"Larynx"
# raw.file$disease[as.character(raw.file$CancerSite)=="Advanced Prostate"]<-"APCA"
# raw.file$disease[as.character(raw.file$CancerSite)=="Prostate"]<-"APCA"
# raw.file$disease[as.character(raw.file$CancerSite)=="All Invasive Cancer Sites Combined"]<-"ALLCANCER"
# raw.file$disease[as.character(raw.file$CancerSite)=="All Invasive Cancer Sites"]<-"ALLCANCER"
# 
# raw.file$disease[as.character(raw.file$CancerSite)=="Ischemic heart disease"]<-"IHD"
# raw.file$disease[as.character(raw.file$CancerSite)=="Ischemic stroke"]<-"ISTK"
# raw.file$disease[as.character(raw.file$CancerSite)=="Hemorrhagic stroke"]<-"HSTK"
# raw.file$disease[as.character(raw.file$CancerSite)=="Other stroke"]<-"OSTK"
# raw.file$disease[as.character(raw.file$CancerSite)=="Diabetes, type 2"]<-"DIAB"
# raw.file$disease[as.character(raw.file$CancerSite)=="Hypertensive heart disease"]<-"HHD"
# raw.file$disease[as.character(raw.file$CancerSite)=="Aortic aneurysm"]<-"AA"
# raw.file$disease[as.character(raw.file$CancerSite)=="Rheumatic heart disease"]<-"RHD"
# raw.file$disease[as.character(raw.file$CancerSite)=="Endocarditis"]<-"ENDO"
# raw.file$disease[as.character(raw.file$CancerSite)=="Other cardiovascular and circulatory diseases"]<-"OTH"
# raw.file$disease[as.character(raw.file$CancerSite)=="Cardiomyopathy and myocarditis"]<-"CM"
# raw.file$disease[as.character(raw.file$CancerSite)=="Atrial fibrillation and flutter"]<-"AFF"
# raw.file$disease[as.character(raw.file$CancerSite)=="Peripheral vascular disease"]<-"PVD"
# raw.file$disease[as.character(raw.file$CancerSite)=="Total strokes"]<-"TSTK"
# 
# raw.file$disease[as.character(raw.file$CancerSite)=="IHD"]<-"IHD"


# raw.file<-raw.file[raw.file$disease!="ECSCN",]
# raw.file<-raw.file[raw.file$disease!="MC",]

# rename disease
raw.file <- raw.file %>% rename("disease" = "diseases")

#vars.to.keep<-c("disease", "Sex", "age_gp", "race_gp", "count", "se")
vars.to.keep<-c("disease", "subgroup", "Sex", "Age_label", "Race_label", "count", "se")
mort<-raw.file[,vars.to.keep]


##fill in missing (e.g male uterine, female prostate etc..)
# age_gp<-as.data.frame(unique(mort$age_gp))
# names(age_gp)<-"age_gp"
# Sex<-as.data.frame(unique(mort$Sex))
# names(Sex)<-"Sex"
# race_gp<-as.data.frame(unique(mort$race_gp))
# names(race_gp)<-"race_gp"
# disease<-as.data.frame(unique(mort$disease))
# names(disease)<-"disease"
# 
# subgroups<-list(age_gp, Sex, race_gp, disease)
# subgroups.merged<-Reduce(function(...) merge(..., all=T), subgroups)
# 
# mort<-merge(mort, subgroups.merged, all=TRUE)
# 
# if(length(mort[is.na(mort$count),]$count)>0)
#   mort[is.na(mort$count),]$count<-0
# if(length(mort[is.na(mort$se),]$se)>0)
#   mort[is.na(mort$se),]$se<-0
# 
# mort$agecat<-as.numeric(as.factor(mort$age_gp))
# 
# #####Edits made by Heesun##########
# mort$female<-as.numeric(mort$Sex)
# mort$female[as.numeric(mort$Sex)==2]<-0
# #mort$female<-swap(as.numeric(mort$Sex)-1, from=c(0,1), to=c(1,0))
# 
# mort$race <- as.numeric(as.factor(mort$race_gp))
# ### Other - 2, Black - 1, White - 3 ###
# mort$race[as.numeric(as.factor(mort$race_gp))==1]<-2
# mort$race[as.numeric(as.factor(mort$race_gp))==2]<-3
# mort$race[as.numeric(as.factor(mort$race_gp))==3]<-1
# ### Other - 3, Black - 2, White -1 ###
# #mort$race<-swap(as.numeric(mort$race_gp), from=c(1,2,3,4), to=c(3,2,1,4))
# #################################################
```

Loop through each row and generate mort/incidence sims based on mean and standard error for each subgroup. 
```{r pressure, eval=FALSE, echo=TRUE}
observed.mort.draws<-matrix(data=NA, nrow=dim(mort)[1], ncol=nsim1)
for(i in 1:dim(mort)[1])
{
  temp<-rnorm(n=nsim1, mean=mort$count[i], sd=mort$se[i])
  temp[temp<0]<-0
  observed.mort.draws[i,]<-temp
}
observed.mort.draws<-cbind(mort, observed.mort.draws)
```

Legacy code, commented out, used to combine different cancers certain cancers in broader categories. We've elected to combine diseases into braoder disease groups at the output processing stage so this is obsolete now.
```{r obsolete, eval=FALSE, echo=TRUE}
########Trying to move away from code that explicitly mentions diseases of interest so that it can be used more generally
######To that end, will comment out following code and move work on disease combinations in a different set of r scripts.
# allcancer.observed.mort.draws<-observed.mort.draws[observed.mort.draws$disease=="ALLCANCER",]
# allcancer.observed.mort.draws$disease<-"allcancer"
# ececa.observed.mort.draws<-observed.mort.draws[observed.mort.draws$disease=="EC",]
# ececa.observed.mort.draws$disease<-"ececa"
# 
# AllSCSummed.observed.mort.draws<-observed.mort.draws[observed.mort.draws$disease=="SC",]
# AllSCSummed.observed.mort.draws$disease<-"AllSCSummed"
# 
# Oral.observed.mort.draws<-observed.mort.draws[observed.mort.draws$disease=="MPLC",1:9]
# oral<-ddply(observed.mort.draws[observed.mort.draws$disease=="MPLC" | observed.mort.draws$disease=="Larynx", -(1:6)],
#       c("agecat", "female", "race"), colSums, .drop=FALSE)
# oral[,1:3]<-oral[,1:3]/2
# Oral.observed.mort.draws<-merge(Oral.observed.mort.draws, oral)
# Oral.observed.mort.draws$disease<-"Oral"
# 
# sumcancer.observed.mort.draws<-observed.mort.draws[observed.mort.draws$disease=="CC",1:9]
# sumcancer<-ddply(observed.mort.draws[
#                                      observed.mort.draws$disease=="CC" | observed.mort.draws$disease=="BC" |
#                                      observed.mort.draws$disease=="GC" | observed.mort.draws$disease=="SC" |
#                                      observed.mort.draws$disease=="PC" | observed.mort.draws$disease=="KC" |
#                                      observed.mort.draws$disease=="LVC" | observed.mort.draws$disease=="TC" |
#                                      observed.mort.draws$disease=="OC" | observed.mort.draws$disease=="UC" |
#                                      observed.mort.draws$disease=="ECA" |
#                                      observed.mort.draws$disease=="MMC" |
#                                      observed.mort.draws$disease=="MPLC" |
#                                      observed.mort.draws$disease=="Larynx" | observed.mort.draws$disease=="APCA", -(1:6)],
#             c("agecat", "female", "race"), colSums, .drop=FALSE)
# sumcancer[,1:3]<-sumcancer[,1:3]/14
# sumcancer.observed.mort.draws<-merge(sumcancer.observed.mort.draws, sumcancer)
# sumcancer.observed.mort.draws$disease<-"sumcancer"
# 
# observed.mort.draws<-rbind(observed.mort.draws, allcancer.observed.mort.draws, ececa.observed.mort.draws, 
#                            AllSCSummed.observed.mort.draws, Oral.observed.mort.draws, sumcancer.observed.mort.draws)
```

Duplicate the sims to use for estimating effects from mediated pathways, as well as combined effects (as in, combining direct and mediated pahways). Combine the duplicated sims into one file.  
```{r medation+total, eval=FALSE, echo=TRUE}
medBMI.observed.mort.draws<-observed.mort.draws
medBMI.observed.mort.draws$disease<-paste(observed.mort.draws$disease, "_medBMI", sep="")

medSBP.observed.mort.draws<-observed.mort.draws
medSBP.observed.mort.draws$disease<-paste(observed.mort.draws$disease, "_medSBP", sep="")

total.observed.mort.draws<-observed.mort.draws
total.observed.mort.draws$disease<-paste(observed.mort.draws$disease, "_total", sep="")

observed.mort.draws<-rbind(observed.mort.draws, medBMI.observed.mort.draws, medSBP.observed.mort.draws, total.observed.mort.draws)
```

Save sims as a csv file. Don't be confused by the file name, it's just another artifact from the days the code was used for the cancer CRA project. "observed.mort.draws" contains simulation draws for morality/incidence counts of the subgroups for CMD/Cancer, by subgroup of interest.
```{r save, eval=FALSE, echo=TRUE}
#write.csv(x=observed.mort.draws, file="CRA_inputs/observed.cancer.mortality.draws.csv")
write.csv(x=observed.mort.draws, file="observed.cancer.mortality.draws.csv")
```

